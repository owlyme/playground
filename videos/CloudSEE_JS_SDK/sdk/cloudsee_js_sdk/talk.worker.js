function Talkloader(){this.logger=new Logger("Talkloader"),this.ws=null,this.heartbeatTimer=null,this.heartbeatTimes=0,this.handShakeData=null,this.heartbeatPingData=null,this.audioBufferArray=[]}self.importScripts("enumConstant.js","logger.js"),Talkloader.prototype.appendBuffer=function(e,t){var a=new Uint8Array(e.byteLength+t.byteLength);return a.set(new Uint8Array(e),0),a.set(new Uint8Array(t),e.byteLength),a.buffer},Talkloader.prototype.requestWebsocket=function(e,t){var a=this;null===this.ws?(this.ws=new WebSocket(e),this.ws.binaryType="arraybuffer",this.ws.onopen=function(e){a.logger.logInfo("talkWs connected."),a.heartbeatTimes=0,a.ws.send(a.handShakeData),a.startHeartbeatTimer(a.heartbeatPingData),a.initTalkEncode()},this.ws.onerror=function(e){a.logger.logError("talkWs connect error "+e.data),a.heartbeatTimes=0},this.ws.onclose=function(e){clearInterval(a.heartbeatTimer),a.ws=null,req={t:common.socketActiveClose,d:e.code,w:e.wasClean},self.postMessage(req),a.heartbeatTimes=0},this.ws.onmessage=this.onmessage.bind(this)):this.ws.onmessage=this.onmessage.bind(this)},Talkloader.prototype.onmessage=function(e){this.heartbeatTimes=0;var t=e.data;let a={t:common.kGetDeviceInfo,d:t};self.postMessage(a)},Talkloader.prototype.startHeartbeatTimer=function(e){this.ws&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval((()=>{this.ws.send(e),this.heartbeatTimes=this.heartbeatTimes+1,this.heartbeatTimes>3&&(this.ws.close(),clearInterval(this.heartbeatTimer),this.ws=null,req={t:common.talkSocketNoActive},self.postMessage(req),this.heartbeatTimes=0)}),13e3))},Talkloader.prototype.initTalkEncode=function(){var e={t:common.initTalkEncode,s:new Date};self.postMessage(e)},Talkloader.prototype.setTalkStartRep=function(e){this.ws.send(e)},Talkloader.prototype.setTopCMD=function(e){this.ws&&this.ws.send(e)},Talkloader.prototype.setTalkG711Data=function(e){this.ws&&(this.audioBufferArray.length>=12?(this.audioBufferArray.shift(),this.audioBufferArray.push(e)):this.audioBufferArray.push(e),0===this.ws.bufferedAmount&&(this.ws.send(this.audioBufferArray[0]),this.audioBufferArray.shift()))},Talkloader.prototype.closeWebsocket=function(e){this.ws&&(this.ws.close(),clearInterval(this.heartbeatTimer),this.ws=null)},Talkloader.prototype.setHandShakeData=function(e){this.handShakeData=e},Talkloader.prototype.setHeartbeatPingData=function(e){this.heartbeatPingData=e},Talkloader.prototype.heartPingResp=function(){this.heartbeatTimes=0},self.talkloader=new Talkloader,self.onmessage=function(e){if(self.talkloader){var t=e.data;switch(t.t){case common.fetchStream:self.talkloader.requestWebsocket(t.url);break;case common.DownloaderHeartBeat:self.talkloader.setHeartbeatPingData(t.b);break;case common.TalkHandshakeReq:self.talkloader.setHandShakeData(t.b);break;case common.talkStartRep:self.talkloader.setTalkStartRep(t.b);break;case common.kgetTalkStartRep:self.talkloader.setTalkG711Data(t.b);break;case common.closeWebsocket:self.talkloader.closeWebsocket();break;case common.heartPingResp:self.talkloader.heartPingResp();break;case common.talkStopResponse_to_talkWorker:self.talkloader.setTopCMD(t.b);break;case common.DestroyTalkReq:self.talkloader.closeWebsocket();break;default:self.talkloader.logger.logError("Unsupport messsage "+t.t)}}};