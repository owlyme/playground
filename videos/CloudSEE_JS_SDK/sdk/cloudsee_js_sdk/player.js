!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.jPlayer=t():e.jPlayer=t()}(window,(function(){return function(e){var t={};function i(o){if(t[o])return t[o].exports;var s=t[o]={i:o,l:!1,exports:{}};return e[o].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=e,i.c=t,i.d=function(e,t,o){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(i.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(o,s,function(t){return e[t]}.bind(null,s));return o},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=2)}([function(e,t,i){var o,s;o="undefined"!=typeof window?window:this,s=function(e,t){const i={closeTalk:60,TalkHandshakeReq:59,kFileData:1,kInitDecoderReq:0,kUninitDecoderReq:1,kOpenDecoderReq:2,kCloseDecoderReq:3,kFeedDataReq:4,kStartDecodingReq:5,kPauseDecodingReq:6,kInitDecoderRsp:0,kUninitDecoderRsp:1,kOpenDecoderRsp:2,kCloseDecoderRsp:10,kVideoFrame:4,kAudioFrame:5,kDecodeFinishedEvt:8,cmdCallback:11,kGetParamRsp:12,sendDataCallback:13,socketLinkState:14,getHeartBeatRequest:15,DownloaderHeartBeat:16,closeWebsocket:17,fetchStream:18,resetDecoderFifo:19,getSetPlayBackSpeedReq:20,getSetPlayBackStartReq:21,deviceReady:22,getSetPlayBackStartTimeReq:23,responseCurDateTime:24,eventTypeFifoFull:25,eventTypeFifoEnough:26,playbakcRecordList:27,socketActiveClose:28,serverDataTimeout:29,heartPingResp:30,serverDecoderError:31,socketNoActive:32,getHandsharkReq:33,getHandsharkRes:34,recoderStart:35,recoderPause:36,onWasmLoaded:37,getHandshakeReq:38,DownloaderHandshakeReq:39,sendHandshakeReq:40,kVideoDownRep:100,kVideoDownChumksRep:101,getTalkStartReq:50,talkStartRep:51,pcmDataReq:52,kStartTalkEncoderRsq:53,kStartTalkEncoderRsp:54,kGetDeviceInfo:55,kGetAudioDataReq:56,kgetTalkStartRep:57,DestroyTalkReq:58,kStartTalkEncoderdeviceready:61,_getTalkStartReq:62,serverDecoderTalkError:63,initTalkEncode:64,talkSocketNoActive:65,talkStopResponse:66,talkStopResponse_to_dec:67,talkStopResponse_to_talkWorker:68,DestroyTalkRes:69,PlaybackOver:70,ServerMaxPlayDurationReached:80,ServerMaxTalkDurationReached:90};return e.common=i,i},"object"==typeof e.exports?e.exports=o.document?s(o):function(e){if(!e.document)throw new Error("common requires a window with a document");return s(e)}:s(o)},function(e,t,i){var o,s;o="undefined"!=typeof window?window:this,s=function(e,t){function i(e){this.module=e}return i.prototype.log=function(e){},i.prototype.logError=function(e){},i.prototype.logInfo=function(e){},i.prototype.logDebug=function(e){},i.prototype.currentTimeStr=function(){var e=new Date(Date.now());return e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()+" "+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()+":"+e.getMilliseconds()},e.Logger=i,i},"object"==typeof e.exports?e.exports=o.document?s(o):function(e){if(!e.document)throw new Error("Logger requires a window with a document");return s(e)}:s(o)},function(e,t,i){"use strict";function o(e){this.init(e)}i.r(t),i.d(t,"playerStateIdle",(function(){return R})),i.d(t,"playerStatePlaying",(function(){return E})),i.d(t,"playerStatePausing",(function(){return k})),o.prototype.init=function(e){this.option={encoding:"16bitInt",channels:1,sampleRate:8e3,flushingTime:5e3,...e},this.samples=new Float32Array,this.flush=this.flush.bind(this),this.interval=setInterval(this.flush,this.option.flushingTime),this.maxValue=this.getMaxValue(),this.TypedArray=this.getTypedArray(),this.createContext()},o.prototype.getMaxValue=function(){var e={"8bitInt":128,"16bitInt":32768,"32bitInt":2147483648,"32bitFloat":1};return e[this.option.encoding]?e[this.option.encoding]:e["16bitInt"]},o.prototype.getTypedArray=function(){var e={"8bitInt":Int8Array,"16bitInt":Int16Array,"32bitInt":Int32Array,"32bitFloat":Float32Array};return e[this.option.encoding]?e[this.option.encoding]:e["16bitInt"]},o.prototype.createContext=function(){this.audioCtx=new(window.AudioContext||window.webkitAudioContext),this.gainNode=this.audioCtx.createGain(),this.gainNode.gain.value=1,this.gainNode.connect(this.audioCtx.destination),this.startTime=this.audioCtx.currentTime},o.prototype.isTypedArray=function(e){return e.byteLength&&e.buffer&&e.buffer.constructor==ArrayBuffer},o.prototype.feed=function(e){if(this.isTypedArray(e)){e=this.getFormatedValue(e);var t=new Float32Array(this.samples.length+e.length);t.set(this.samples,0),t.set(e,this.samples.length),this.samples=t}},o.prototype.getFormatedValue=function(e){e=new this.TypedArray(e.buffer);var t,i=new Float32Array(e.length);for(t=0;t<e.length;t++)i[t]=e[t]/this.maxValue;return i},o.prototype.volume=function(e){this.gainNode.gain.value=e},o.prototype.destroy=function(){this.interval&&clearInterval(this.interval),this.samples=null,this.audioCtx.close(),this.audioCtx=null},o.prototype.createAudioAssembly=function(e){var t,i,o,s,r,a=this.audioCtx.createBufferSource(),n=e.length/this.option.channels,h=this.audioCtx.createBuffer(this.option.channels,n,this.option.sampleRate);for(i=0;i<this.option.channels;i++)for(t=h.getChannelData(i),o=i,r=50,s=0;s<n;s++)t[s]=e[o],s<50&&(t[s]=t[s]*s/50),s>=n-51&&(t[s]=t[s]*r--/50),o+=this.option.channels;this.startTime<this.audioCtx.currentTime&&(this.startTime=this.audioCtx.currentTime),a.buffer=h,a.connect(this.gainNode),a.start(this.startTime),this.startTime+=h.duration},o.prototype.flush=function(){this.samples.length&&(this.createAudioAssembly(this.samples),this.samples=new Float32Array)},o.prototype.getTimestamp=function(){return this.audioCtx?this.audioCtx.currentTime:0},o.prototype.play=function(e){this.isTypedArray(e)&&(e=this.getFormatedValue(e)).length&&this.createAudioAssembly(e)},o.prototype.pause=function(){"running"===this.audioCtx.state&&this.audioCtx.suspend()},o.prototype.resume=function(){"suspended"===this.audioCtx.state&&this.audioCtx.resume()};var s=o;function r(e){this.gl=e,this.texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)}function a(e,t){this.canvas=e,this.gl=e.getContext("webgl",t)||e.getContext("experimental-webgl"),this.program=null,this.verticesBuffer=null,this.texCoordBuffer=null,this.initGL(t)}r.prototype.fill=function(e,t,i){var o=this.gl;o.bindTexture(o.TEXTURE_2D,this.texture),o.texImage2D(o.TEXTURE_2D,0,o.LUMINANCE,e,t,0,o.LUMINANCE,o.UNSIGNED_BYTE,i)},a.prototype.initGL=function(e){if(this.gl){var t=this.gl;t.pixelStorei(t.UNPACK_ALIGNMENT,1);var i=t.createProgram();this.program=i;var o=["attribute highp vec4 aVertexPosition;","attribute vec2 aTextureCoord;","varying highp vec2 vTextureCoord;","void main(void) {"," gl_Position = aVertexPosition;"," vTextureCoord = aTextureCoord;","}"].join("\n"),s=t.createShader(t.VERTEX_SHADER);t.shaderSource(s,o),t.compileShader(s);var a=["precision highp float;","varying lowp vec2 vTextureCoord;","uniform sampler2D YTexture;","uniform sampler2D UTexture;","uniform sampler2D VTexture;","const mat4 YUV2RGB = mat4","("," 1.1643828125, 0, 1.59602734375, -.87078515625,"," 1.1643828125, -.39176171875, -.81296875, .52959375,"," 1.1643828125, 2.017234375, 0, -1.081390625,"," 0, 0, 0, 1",");","void main(void) {"," gl_FragColor = vec4( texture2D(YTexture, vTextureCoord).x, texture2D(UTexture, vTextureCoord).x, texture2D(VTexture, vTextureCoord).x, 1) * YUV2RGB;","}"].join("\n"),n=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(n,a),t.compileShader(n),t.attachShader(i,s),t.attachShader(i,n),t.linkProgram(i),t.deleteShader(s),t.deleteShader(n),t.useProgram(i),t.getProgramParameter(i,t.LINK_STATUS);var h=t.getAttribLocation(i,"aVertexPosition");t.enableVertexAttribArray(h);var l=t.getAttribLocation(i,"aTextureCoord");t.enableVertexAttribArray(l);var c=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,c),t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0]),t.STATIC_DRAW),t.vertexAttribPointer(h,3,t.FLOAT,!1,0,0);var d=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,d),t.bufferData(t.ARRAY_BUFFER,new Float32Array([1,0,0,0,1,1,0,1]),t.STATIC_DRAW),t.vertexAttribPointer(l,2,t.FLOAT,!1,0,0),this.verticesBuffer=c,this.texCoordBuffer=d,t.y=new r(t),t.u=new r(t),t.v=new r(t),t.y.bind(0,i,"YTexture"),t.u.bind(1,i,"UTexture"),t.v.bind(2,i,"VTexture")}},a.prototype.renderFrame=function(e,t,i,o,s){if(this.gl){var r=this.gl;r.viewport(0,0,r.canvas.width,r.canvas.height),r.clearColor(0,0,0,0),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),r.y.fill(t,i,e.subarray(0,o)),r.u.fill(t>>1,i>>1,e.subarray(o,o+s)),r.v.fill(t>>1,i>>1,e.subarray(o+s,e.length)),r.drawArrays(r.TRIANGLE_STRIP,0,4)}},a.prototype.fullscreen=function(){var e=this.canvas;e.RequestFullScreen?e.RequestFullScreen():e.webkitRequestFullScreen?e.webkitRequestFullScreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.msRequestFullscreen?e.msRequestFullscreen():alert("This browser doesn't supporter fullscreen")},r.prototype.bind=function(e,t,i){var o=this.gl;o.activeTexture([o.TEXTURE0,o.TEXTURE1,o.TEXTURE2][e]),o.bindTexture(o.TEXTURE_2D,this.texture),o.uniform1i(o.getUniformLocation(t,i),e)},a.prototype.exitfullscreen=function(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen?document.msExitFullscreen():alert("Exit fullscreen doesn't work")},a.prototype.webGLDestroy=function(){var e=this.gl,t=this.program;e.clear(e.COLOR_BUFFER_BIT),e.clear(e.DEPTH_BUFFER_BIT),e.clear(e.STENCIL_BUFFER_BIT),e.deleteProgram(t);var i=this.verticesBuffer,o=this.texCoordBuffer;e.deleteBuffer(i),e.deleteBuffer(o);var s=e.y.texture,r=e.u.texture,a=e.v.texture;e.deleteTexture(s),e.deleteTexture(r),e.deleteTexture(a),this.canvas=null,this.gl=null};var n=a,h=i(1),l=i.n(h);new l.a("Event").logInfo("Event.js 已加载");class c{constructor(e){this.target={},this.eventsQueue={},this.disallowRepeat=!1}add(e=[],t,i){for(let o of e)this.on(o,t,i)}on(e,t,i){if(void 0===this.eventsQueue[e]&&(this.eventsQueue[e]={methods:[]}),"function"==typeof t){if(!this.disallowRepeat||!this.eventsQueue[e].methods.includes(t))return void 0!==i&&(t.once=i),this.eventsQueue[e].methods.push(t),this.target}else logger.error("on","the argument is not function.",t)}once(e,t){this.on(e,t,!0)}off(e,t){let i=this.eventsQueue[e];if(!i)return;let o=i.methods;if(t){let e=o.length;for(;e--;)o[e]===t&&o.splice(e,1)}else delete this.eventsQueue[e];return this.target}emit(e,...t){let i=this.eventsQueue[e];if(i)return i.methods.forEach((i=>{i.apply(this.target,t),i.once&&this.off(e,i)})),this.target}clear(e){delete this.eventsQueue[e]}clearAll(){this.eventsQueue={}}}var d=function(e){const t=new c(e);return e=>(t.target=e,t)};var u=i(0),p=i.n(u);function m(e,t){let i=t||{};if(!e)return;this.canvasContainer=e,e.style.position="relative";const o=parseInt(getComputedStyle(e).width),s=parseInt(getComputedStyle(e).height);this.conW=o,this.conH=s;const r=document.createElement("canvas");r.width=o,r.height=s,r.style.cssText="transform: scale(1);transform-origin: 0 0;",r.setAttribute("class","videoCanvas"),this.msg="链接已断开";const a=document.createElement("div");a.style.cssText="position: absolute;z-index: 2;background-color: rgba(0, 0, 0, 0);margin: 0;top: 0;right: 0;bottom: 0;left: 0;",e.appendChild(r),e.appendChild(a),a.setAttribute("class","videoCanvasMsg");this.container_el=e,this.canvas=r,this.stateContainer_el=a,this.loading_el_str=i.loading_el_str?i.loading_el_str:'<div style="top: 50%;margin-top: -21px;width: 100%;text-align: center;position: absolute;"><svg t="1607391066926" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1837" width="20" height="20"><path d="M512 64q14.016 0 23.008 8.992T544 96v192q0 14.016-8.992 23.008T512 320t-23.008-8.992T480 288V96q0-14.016 8.992-23.008T512 64z m0 640q14.016 0 23.008 8.992T544 736v192q0 14.016-8.992 23.008T512 960t-23.008-8.992T480 928v-192q0-14.016 8.992-23.008T512 704z m448-192q0 14.016-8.992 23.008T928 544h-192q-14.016 0-23.008-8.992T704 512t8.992-23.008T736 480h192q14.016 0 23.008 8.992T960 512z m-640 0q0 14.016-8.992 23.008T288 544H96q-14.016 0-23.008-8.992T64 512t8.992-23.008T96 480h192q14.016 0 23.008 8.992T320 512zM195.008 195.008q10.016-8.992 23.008-8.992t22.016 8.992l136 136q8.992 10.016 8.992 22.496t-9.504 22.016-22.016 9.504-22.496-8.992l-136-136q-8.992-8.992-8.992-22.016t8.992-23.008zM648 648q10.016-10.016 22.496-10.016t22.496 10.016l136 136q8.992 8.992 8.992 22.016t-9.504 22.496-22.496 9.504-22.016-8.992l-136-136q-10.016-10.016-10.016-22.496t10.016-22.496z m180.992-452.992q8.992 10.016 8.992 23.008t-8.992 22.016l-136 136q-10.016 8.992-22.496 8.992t-22.016-9.504-9.504-22.016 8.992-22.496l136-136q8.992-8.992 22.016-8.992t23.008 8.992zM376 648q10.016 10.016 10.016 22.496t-10.016 22.496l-136 136q-8.992 8.992-22.016 8.992t-22.496-9.504-9.504-22.496 8.992-22.016l136-136q10.016-10.016 22.496-10.016t22.496 10.016z" p-id="1838" fill="#A4A9B3"></path></svg><p style="color: #A4A9B3;margin: 3px 0;font-size: 14px;">视频连接中...</p></div>',this.pauseimg_el_str=i.pauseimg_el_str?i.pauseimg_el_str:'<div id="iconPlay" style="width: 120px;height: 120px;position: absolute;left: 50%;top: 50%;transform: translate(-50%,-50%);display: flex;align-items: center;justify-content: center;" class="iconPlay">\n    <svg width="61px" height="60px" viewBox="0 0 61 60" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n        <title>重播</title>\n        <g id="实时预览-云台" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\n            <g id="录像回放/重播按钮" transform="translate(-827.000000, -257.000000)">\n                <g id="编组-5" transform="translate(510.000000, 110.000000)">\n                    <g id="重播" transform="translate(317.500000, 147.000000)">\n                        <rect id="矩形" fill="#1F1F1F" style="mix-blend-mode: multiply;" opacity="0.565970285" x="0" y="0" width="60" height="60" rx="30"></rect>\n                        <path d="M34.7557911,21.2189504 L44.4776159,39.0422957 C45.0065413,40.0119924 44.6492256,41.2268657 43.679529,41.7557911 C43.3857518,41.9160333 43.0564627,42 42.7218247,42 L23.2781753,42 C22.1736058,42 21.2781753,41.1045695 21.2781753,40 C21.2781753,39.665362 21.362142,39.3360729 21.5223841,39.0422957 L31.2442089,21.2189504 C31.7731343,20.2492538 32.9880076,19.8919381 33.9577043,20.4208635 C34.2948373,20.6047543 34.5719004,20.8818174 34.7557911,21.2189504 Z" id="三角形备份" fill="#FFFFFF" transform="translate(33.000000, 30.000000) rotate(-270.000000) translate(-33.000000, -30.000000) "></path>\n                    </g>\n                </g>\n            </g>\n        </g>\n    </svg>\n    </div>',this.msg_el_str=i.msg_el_str?i.msg_el_str():function(e){return`<div style="top: 50%;margin-top: -21px;width: 100%;text-align: center;position: absolute;"><p style="color: #A4A9B3;margin: 3px 0;font-size: 14px;">${e}</p></div>`},this.stateContainer_el.innerHTML=""}m.prototype._showOrHideShade=function(e){this.stateContainer_el.style.backgroundColor=e},m.prototype.showPauseIcon=function(){this._showOrHideShade("rgba(0,0,0,0)"),this.pauseimg_el_str.nodeType?(this.stateContainer_el.innerHTML="",this.stateContainer_el.appendChild(this.pauseimg_el_str)):this.stateContainer_el.innerHTML=this.pauseimg_el_str},m.prototype.showLoading=function(){this._showOrHideShade("rgba(0,0,0,1)"),this.stateContainer_el.innerHTML="",this.loading_el_str.nodeType?(this.stateContainer_el.innerHTML="",this.stateContainer_el.appendChild(this.loading_el_str)):this.stateContainer_el.innerHTML=this.loading_el_str},m.prototype.showMsg=function(e,t){this._showOrHideShade("rgba(0,0,0,1)"),this.stateContainer_el.innerHTML="";let i=null;i=e||t?"function"==typeof this.msg_el_str&&e?this.msg_el_str(e,t):this.msg_el_str(t):this.msg_el_str(""),i.nodeType?(this.stateContainer_el.innerHTML="",this.stateContainer_el.appendChild(i)):this.stateContainer_el.innerHTML=i},m.prototype.hideAll=function(){this._showOrHideShade("rgba(0,0,0,0)"),this.msg="",this.stateContainer_el.innerHTML=""};var f=m;var g={4:{code:4,code16:4,eventStr:"SERVER_UNKNOWN_ERROR",msg:"服务器未知错误"},5:{code:5,code16:5,eventStr:"SERVER_NOT_READY",msg:"服务器未准备好"},6:{code:6,code16:6,eventStr:"SERVER_USER_ABORT",msg:"服务器端用户主动断开"},7:{code:7,code16:7,eventStr:"SERVER_STOPPED",msg:"服务器服务已停止"},8:{code:8,code16:8,eventStr:"SERVER_ABORT",msg:"服务器服务已中断"},9:{code:9,code16:9,eventStr:"SERVER_STREAM_STOP",msg:"服务器流停止"},10:{code:10,code16:10,eventStr:"SERVER_CONNECT_DEV_FAILED",msg:"连接设备失败"},11:{code:11,code16:11,eventStr:"SERVER_SUBDEV_STREAM_ERR",msg:"订阅设备流失败"},12:{code:12,code16:12,eventStr:"SERVER_INVALID_CONTEXT",msg:"不合法的上下文"},13:{code:13,code16:13,eventStr:"SERVER_DEVICE_TIMEOUT",msg:"设备超时"},14:{code:14,code16:14,eventStr:"SERVER_CLIENT_TIMEOUT",msg:"客户端超时"},15:{code:15,code16:15,eventStr:"SERVER_OVER_DEV_LIMIT",msg:"超过设备最大连接数"},16:{code:16,code16:16,eventStr:"SERVER_PERM_DENIED",msg:"无权限"},17:{code:17,code16:17,eventStr:"SERVER_DATA_TIMEOUT",msg:"数据超时"},18:{code:18,code16:18,eventStr:"SERVER_DEVICE_ABORT",msg:"服务器端设备主动断开"}};let y=function(e,t=16,i=48e3){t=t,i=i;var o=new AudioContext,s=o.createMediaStreamSource(e),r=o.createScriptProcessor(4096,1,1),a={size:0,buffer:[],inputSampleRate:i,inputSampleBits:16,outputSampleRate:8e3,oututSampleBits:t,clear:function(){this.buffer=[],this.size=0},input:function(e){this.buffer.push(new Float32Array(e)),this.size+=e.length},compress:function(){for(var e=new Float32Array(this.size),t=0,i=0;i<this.buffer.length;i++)e.set(this.buffer[i],t),t+=this.buffer[i].length;for(var o=parseInt(this.inputSampleRate/this.outputSampleRate),s=e.length/o,r=new Float32Array(s),a=0,n=0;a<s;)r[a]=e[n],n+=o,a++;return r},encodePCM:function(){Math.min(this.inputSampleRate,this.outputSampleRate);for(var e=Math.min(this.inputSampleBits,this.oututSampleBits),t=this.compress(),i=t.length*(e/8),o=new ArrayBuffer(i),s=new DataView(o),r=0,a=0;a<t.length;a++,r+=2){var n=Math.max(-1,Math.min(1,t[a]));s.setInt16(r,n<0?32768*n:32767*n,!0)}return new Blob([s])}};this.start=function(){s.connect(r),r.connect(o.destination)},this.stop=function(){r.disconnect()},this.getBlob=function(){return a.encodePCM()},this.clear=function(){a.clear()},r.onaudioprocess=function(e){a.input(e.inputBuffer.getChannelData(0))}};const R=0,E=1,k=2;function S(e){this.url=e.url,this.endtime=e.endtime,this.isStream=e.isStream,this.k=e.encrypted_key,this.i=e.encrypted_iv,this.ct=e.encrypted_type,this.streamHighWaterFrame=e.streamHighWaterFrame?e.streamHighWaterFrame:25,this.playbackHighWaterFrame=e.playbackHighWaterFrame?e.playbackHighWaterFrame:25,this.playbackLowWaterFrame=e.playbackLowWaterFrame?e.playbackLowWaterFrame:10,this.language=e.language?e.language:"ch",this.deviceName=e.deviceName?e.deviceName:"设备"}function v(e,t){var i;this.el=e,this.observer=null,this.event=d(this)(),(i=this.event).on("SERVER_UNKNOWN_ERROR",((e,t)=>{i.emit("UNKNOWN_ERROR",e,t)})),i.on("SERVER_NOT_READY",((e,t)=>{i.emit("NOT_READY",e,t)})),i.on("SERVER_USER_ABORT",((e,t)=>{i.emit("USER_ABORT",e,t)})),i.on("SERVER_STOPPED",((e,t)=>{i.emit("STOPPED",e,t)})),i.on("SERVER_ABORT",((e,t)=>{i.emit("ABORT",e,t)})),i.on("SERVER_STREAM_STOP",((e,t)=>{i.emit("STREAM_STOP",e,t)})),i.on("SERVER_CONNECT_DEV_FAILED",((e,t)=>{i.emit("CONNECT_DEV_FAILED",e,t)})),i.on("SERVER_SUBDEV_STREAM_ERR",((e,t)=>{i.emit("SUBDEV_STREAM_ERR",e,t)})),i.on("SERVER_INVALID_CONTEXT",((e,t)=>{i.emit("INVALID_CONTEXT",e,t)})),i.on("SERVER_DEVICE_TIMEOUT",((e,t)=>{i.emit("DEVICE_TIMEOUT",e,t)})),i.on("SERVER_CLIENT_TIMEOUT",((e,t)=>{i.emit("CLIENT_TIMEOUT",e,t)})),i.on("SERVER_OVER_DEV_LIMIT",((e,t)=>{i.emit("OVER_DEV_LIMIT",e,t)})),i.on("SERVER_PERM_DENIED",((e,t)=>{i.emit("PERM_DENIED",e,t)})),i.on("SERVER_DATA_TIMEOUT",((e,t)=>{i.emit("DATA_TIMEOUT",e,t)})),i.on("SERVER_DEVICE_ABORT",((e,t)=>{i.emit("DEVICE_ABORT",e,t)})),i.on("SERVER_MAX_PLAY_DURATION_REACHED",((e,t)=>{i.emit("MAX_PLAY_DURATION_REACHED",e,t)})),i.on("MEDIA_ERROR",(e=>{i.emit("GET_MEDIA_ERROR",e)})),i.on("MEDIA_PROGRESS_INFO",(e=>{i.emit("GET_MEDIA_PROGRESS_INFO",e)})),i.on("DEVICE_RECORD_LIST",(e=>{i.emit("GET_DEVICE_RECORD_LIST",e)})),i.on("MEDIA_PLAY",(()=>{i.emit("GET_MEDIA_PLAY")})),i.on("MEDIA_PAUSE",(()=>{i.emit("GET_MEDIA_PAUSE")})),i.on("MEDIA_STOP",(()=>{i.emit("GET_MEDIA_STOP")})),i.on("VIDEO_MAX_END",(()=>{i.emit("GET_VIDEO_MAX_END")})),i.on("MEDIA_INFO",(e=>{i.emit("GET_MEDIA_INFO",e)})),i.on("VISIBILITY_CHANGE",(e=>{i.emit("GET_VISIBILITY_CHANGE",e)})),i.on("VISIBILITY_TALK_CHANGE",((e,t)=>{i.emit("GET_VISIBILITY_TALK_CHANGE",e,t)})),i.on("TALK_START",(e=>{i.emit("GET_TALK_START",e)})),i.on("TALK_END",(e=>{i.emit("GET_TALK_END",e)})),this.currentVolume=100,this.configInfo=null,this.pcmPlayer=null,this.canvas=null,this.webglPlayer=null,this.frameRate=0,this.pixFmt=0,this.videoWidth=0,this.videoHeight=0,this.yLength=0,this.uvLength=0,this.playerState=R,this.socketSending=!1,this.decoding=!1,this.currentTimestamp="",this.audioEncoding="",this.audioChannels=0,this.audioSampleRate=0,this.sampleFmt=0,this.speedNum=2,this.setFrameRate=1,this.seeking=!1,this.loadingDiv=null,this.loadingState=!0,this.buffering=!1,this.speedLevel=1,this.frameBuffer=[],this.audioFrameBuffer=[],this.isStream=!1,this.logger=new l.a("Player"),this.drawingState=!1,this.speeding=!1,this.playInitState=!0,this.playFirstGetParams=!0,this.requestAnimationFrame=null,this._onSnapshot=null,this._curSpeed=null,this.serverDeviceUnLinkCode=null,this.decoderErrorFlag=!1,this.endtime=null,this.videoInitStatus=!1,this.startTime=0,this.ENDTIME=0;const o=new f(e,t);this.showPauseIcon=()=>{o.showPauseIcon()},this.showLoading=()=>{o.showLoading()},this.showMsg=(e,t)=>{o.showMsg(e,t)},this.hideAll=()=>{o.hideAll()},this._msgController=o,this.talkRecord=null,this.talkTimer=null,this.talkStream=null,this.getAudioDating=!1,this.getAudioDataStatus=!1;this.observer=new MutationObserver((e=>{if(this.videoHeight&&this.videoWidth&&this._msgController){let e=0,t=0;const i=setInterval((()=>{let o=getComputedStyle(this.el).height;if(t==o){if(e++,e>3){clearInterval(i),e=0,t=0;let o=Math.ceil(1e5*parseInt(getComputedStyle(this.el).width)/this.videoWidth)/1e5,s=Math.ceil(1e5*parseInt(getComputedStyle(this.el).height)/this.videoHeight)/1e5;this.canvas.style.cssText=`transform: scale(${o},${s});transform-origin: 0 0;position:absolute;left: 0;top: 0;`}}else t=o}),5)}})),this.observer.observe(this._msgController.canvasContainer,{attributes:!0}),Object.defineProperty(this,"onSnapshot",{set:e=>{this._onSnapshot=e}})}v.prototype.initDownloadWorker=function(e){var t,i=this;this.downloadWorker=new Worker(e+"downloader.worker.js"),this.downloadWorker.onmessage=function(e){var o=e.data;switch(o.t){case p.a.sendHandshakeReq:t={t:p.a.getHandshakeReq},i.decodeWorker.postMessage(t);break;case p.a.kFileData:i.onFileData(o.d);break;case p.a.socketActiveClose:i.onsocketActiveClose(o.d,o.w);break;case p.a.socketNoActive:i.onsocketNoActive()}}},v.prototype.initDecodeWorker=function(e){var t=this;this.decodeWorker=new Worker(e+"decoder.worker.js",{name:e}),this.decodeWorker.onmessage=function(e){var i=e.data;const o={[p.a.kInitDecoderRsp]:"onInitDecoder",[p.a.kOpenDecoderRsp]:"onOpenDecoder",[p.a.kVideoFrame]:"onVideoFrame",[p.a.kAudioFrame]:"onAudioFrame",[p.a.kDecodeFinishedEvt]:"onDecodeFinished",[p.a.sendDataCallback]:"onSendDataCallback",[p.a.kGetParamRsp]:"onGetParam",[p.a.socketLinkState]:"onSocketLinkState",[p.a.getHeartBeatRequest]:"onGetHeartBeatRequest",[p.a.getHandshakeReq]:"onGetHandshakeReq",[p.a.getSetPlayBackSpeedReq]:"onGetSetPlayBackSpeedReq",[p.a.getSetPlayBackStartReq]:"onGetSetPlayBackStartReq",[p.a.deviceReady]:"onDeviceReady",[p.a.getSetPlayBackStartTimeReq]:"onGetSetPlayBackStartTimeReq",[p.a.responseCurDateTime]:"onResponseCurDateTime",[p.a.eventTypeFifoFull]:"onEventTypeFifoFull",[p.a.eventTypeFifoEnough]:"onEventTypeFifoEnough",[p.a.playbakcRecordList]:"onPlaybakcRecordList",[p.a.serverDataTimeout]:"onServerDataTimeout",[p.a.serverDecoderError]:"onDecoderError",[p.a.serverDecoderTalkError]:"onDecoderTalkError",[p.a.heartPingResp]:"onHeartPingResp",[p.a.getHandsharkRes]:"onGetHandsharkRes",[p.a.kCloseDecoderRsp]:"onCloseDecoderRsp",[p.a.onWasmLoaded]:"onWasmLoaded",[p.a.kVideoDownRep]:"onVideoDownRep",[p.a.kVideoDownChumksRep]:"onVideoDownChumksRep",[p.a.getTalkStartReq]:"onTalkStartRep",[p.a.kStartTalkEncoderRsp]:"onStartTalkEncoder",[p.a.kGetAudioDataReq]:"onGetAudioDataReq",[p.a.kgetTalkStartRep]:"onGetAudioDataRep",[p.a.closeTalk]:"onCloseTalk",[p.a.ServerMaxTalkDurationReached]:"onAutoCloseTalk",[p.a.closeWebSocket]:"closeWebSocket",[p.a.kStartTalkEncoderdeviceready]:"onkTalkEncoderdeviceready",[p.a.talkStopResponse_to_talkWorker]:"onTalkStopResponseToTalkWorker",[p.a.talkStopResponse]:"onTalkStopResponse",[p.a.PlaybackOver]:"onPlaybackOver",[p.a.ServerMaxPlayDurationReached]:"onServerMaxPlayDurationReached"};o[i.t]&&t[o[i.t]](i)}},v.prototype.play=function(e){this.frameBuffer.length=0,this.frameBuffer=[],this.audioFrameBuffer=[],this.videoFrameLen=0,this.speedLevel=1,this.videoInitStatus=!1;let{url:t,endtime:i,isStream:o,i:s,k:r,t:a,prefixPath:h}=e;h||(h="/");let l={e:0,m:"Success"},c=this;{if(this.playerState==k)return l=this.resume(),l;if(this.playerState==E)return l;if(!t)return l={e:-1,m:"Invalid url"},this.logger.logError("[ER] playVideo error, url empty."),l;if(!o&&!i)return l={e:-1,m:"Invalid endtime"},this.logger.logError("[ER] playVideo error, endtime empty."),l;if(!("AES-256-GCM"!=a||s&&r))return l={e:-1,m:"Invalid params"},this.logger.logError("[ER] playVideo error, params empty."),l;this.initDownloadWorker(h),this.initDecodeWorker(h),this.initTalkWorker(h),this.canvas=this._msgController.canvas,this.configInfo=null,this.configInfo=new S(e),this.playerState=E,this.isStream=o,this.endtime=i,this.webglPlayer=new n(this.canvas,{preserveDrawingBuffer:!0,antialias:!0}),this.now=null,this.then=Date.now(),this.delta=0,this.playOneFrameStartTime=(new Date).getTime(),this.playOneFrameEndTime=(new Date).getTime(),this.displayLoop();const d={t:p.a.kInitDecoderReq,s:this.isStream?0:1,c:4194304,k:this.configInfo.k,i:this.configInfo.i,ct:this.configInfo.ct};this.decodeWorker.postMessage(d);let u=!1;this.registerVisibilityEvent((function(e){e&&1==c.playerState?(c.getAudioDataStatus&&c.event.emit("VISIBILITY_TALK_CHANGE",e,c.getAudioDating),c.event.emit("VISIBILITY_CHANGE",e),c.getAudioDataStatus&&!c.getAudioDating&&c.startRecord(),c.isStream?1==u&&(c.pcmPlayer&&c.pcmPlayer.resume(),c.decodeWorker.postMessage({t:p.a.resetDecoderFifo}),c.startDecoding(),u=!1):1==u&&(c.resume(),u=!1)):(c.getAudioDataStatus&&c.event.emit("VISIBILITY_TALK_CHANGE",e,c.getAudioDating),c.event.emit("VISIBILITY_CHANGE",e),c.getAudioDataStatus&&c.getAudioDating&&c.talkPause(),c.isStream?(u=!0,c.pcmPlayer&&c.pcmPlayer.pause(),c.pauseDecoding()):c.playerState==E&&(c.pause(),u=!0))})),this.buffering=!0,this.loadingState=!0,this.hideAll(),this.event.emit("GET_MEDIA_PLAY")}return l},v.prototype.seekTo=function(e,t){let i={e:-1,m:"Parameter Null."};if(!e)return this.logger.logError("[ER] seekTo error, time empty."),i;if(this.playerState!=E)return i.m="Player Is NotPlaying",i;this.seeking=!0,this.speeding=!1,this.pauseDecoding(),this.decodeWorker.postMessage({t:p.a.resetDecoderFifo}),this.frameBuffer.length=0,this.audioFrameBuffer=[],this.videoFrameLen=0;const o={t:p.a.getSetPlayBackStartTimeReq,s:e,q:t};return this.decodeWorker.postMessage(o),i.e=0,i.m="SeekTo Success.",i},v.prototype.setSpeed=function(e){let t={e:-1,m:"Parameter Null."};if(!e)return this.logger.logError("[ER] seekTo error, time empty."),t;this.speedLevel=e;const i=["0","1/16","1/8","1/4","1/2","1","2","4","8","16"];let o=["0","0.0625","0.125","0.25","0.5","1","2","4","8","16"].findIndex((t=>t==e));if(o>-1){this.speed(i[o]),"0"!=i[o]&&(this._curSpeed=e),this.event.emit("speedNum",i[o]);const s=parseFloat(e);return s>1&&(this.speeding=!0,this.setFrameRate=this.setFrameRateFn(),this.speedNum=2*s,this.restartAudio()),s>0&&s<1&&(this.speeding=!0,this.speedNum=2,0!=this.frameRate&&(this.setFrameRate=Math.floor(this.setFrameRateFn()/s)),this.restartAudio()),1!=s&&0!=s||(this.speeding=!1,this.speedNum=2,this.setFrameRate=this.setFrameRateFn()),t.e=0,t.m="SetSpeed Success.",t}return t.m="Invalid Parameter.",t},v.prototype.pause=function(){let e={e:-1,m:"Not playing"};if(!this.isStream)return this.playerState!=E||(this.playerState=k,this.pcmPlayer&&this.pcmPlayer.pause(),this.setSpeed("0"),this.pauseDecoding(),this.showPauseIcon(),this.event.emit("GET_MEDIA_PAUSE"),e.e=0,e.m="Pause Success."),e},v.prototype.resume=function(){this.logger.logInfo("Resume.");let e={e:-1,m:"Not pausing"};return this.playerState!=k||(this.playerState=E,this.pcmPlayer&&this.pcmPlayer.resume(),this.startDecoding(),this.setSpeed("1"),this.hideAll(),this.event.emit("GET_MEDIA_PLAY"),e.e=0,e.m="Resume Success."),e},v.prototype.stop=function(e,t){let i={e:-1,m:"Not playing."};return this.playerState==R||(this.playerState=R,this.resetPlayer(e,t),this.getAudioDataStatus&&(this.getAudioDataStatus=!1,this.talkDestroy()),i.e=0,i.m="Stop Success."),i},v.prototype.resetPlayer=function(e,t){this.closeWebsocket(),(window.cancelAnimationFrame||window.mozCancelAnimationFrame)(this.requestAnimationFrame),this.webglPlayer.webGLDestroy(),this.loadingState=!1,this.canvas=null,this.webglPlayer=null,this.frameRate=0,this.pixFmt=0,this.videoWidth=0,this.videoHeight=0,this.yLength=0,this.uvLength=0,this.audioEncoding="",this.audioChannels=0,this.audioSampleRate=0,this.sampleFmt=0,this.speedNum=2,this.setFrameRate=1,this.playerState=R,this.socketSending=!1,this.decoding=!1,this.currentTimestamp="",this.frameBuffer.length=0,this.frameBuffer=[],this.audioFrameBuffer=[],this.buffering=!1,this.drawingState=!1,this.speeding=!1,this.playInitState=!0,this.playFirstGetParams=!0,0,this.requestAnimationFrame=null,this.endtime=null,this._curSpeed=null,this.pcmPlayer&&(this.pcmPlayer.destroy(),this.pcmPlayer=null,this.logger.logInfo("Pcm player released.")),this.logger.logInfo("Closing decoder."),this.decodeWorker.postMessage({t:p.a.kUninitDecoderReq}),this.showMsg(e,t),this.logger.logInfo("Uniniting decoder."),this.observer=null},v.prototype.reconnection=function(){const e={url:this.configInfo.url,endtime:this.configInfo.endtime,isStream:this.configInfo.isStream,k:this.configInfo.k,i:this.configInfo.i,ct:this.configInfo.ct,streamHighWaterFrame:this.configInfo.streamHighWaterFrame,playbackHighWaterFrame:this.configInfo.playbackHighWaterFrame,playbackLowWaterFrame:this.configInfo.playbackLowWaterFrame,language:this.configInfo.language?this.configInfo.language:"ch",deviceName:this.configInfo.deviceName?this.configInfo.deviceName:"设备"};this.play(e)},v.prototype.getCurTimestamp=function(){return this.currentTimestamp},v.prototype.fullscreen=function(){this.webglPlayer&&this.webglPlayer.fullscreen()},v.prototype.getState=function(){return this.playerState},v.prototype.volume=function(e){let t={e:-1,m:"Parameter Null"};return null===e||(null!==this.pcmPlayer&&this.pcmPlayer.volume(e),this.currentVolume=e,t.e=0,t.m="Set Volume Success."),t},v.prototype.recoderStart=function(){var e={t:p.a.recoderStart};this.decodeWorker.postMessage(e)},v.prototype.recoderPause=function(e){var t={t:p.a.recoderPause,s:e};this.decodeWorker.postMessage(t)},v.prototype.setFrameRateFn=function(){return 1},v.prototype.displayLoop=function(){if(this.playerState!=R){let e=window.requestAnimationFrame||window.mozRequestAnimationFrame;this.requestAnimationFrame=e(this.displayLoop.bind(this))}this.playOneFrameEndTime=(new Date).getTime();let e=this.playOneFrameEndTime-this.playOneFrameStartTime;if(this.event.emit("PLAY_ONE_FRAME_TIME",e,this.frameBuffer.length,this.audioFrameBuffer.length,this.decoderUseTime),this.playOneFrameStartTime=this.playOneFrameEndTime,this.playerState==E&&0!=this.frameBuffer.length&&!this.buffering){if(this.videoInitStatus&&this.audioFrameBuffer.length>0)for(let e=0;e<this.audioFrameBuffer.length;e++)this.displayAudioFrame(this.audioFrameBuffer[0])&&this.audioFrameBuffer.shift();if(1==this.speedLevel?(this.now=Date.now(),this.delta=this.now-this.then,this.delta>=this.interval&&(this.then=this.now-this.delta%this.interval,this.loadingState=!1,this.displayVideoFrame(this.frameBuffer[0])&&(this.frameBuffer.shift(),this.videoFrameLen--,this.ENDTIME=new Date,this.videoFrameLen))):this.displayVideoFrame(this.frameBuffer[0])&&(this.frameBuffer.shift(),this.videoFrameLen--),!this.isStream&&this.frameBuffer.length>=this.configInfo.playbackHighWaterFrame&&this.socketSending&&(this.setSpeed("0"),this.event.emit("speedNum",0)),!this.isStream&&this.frameBuffer.length<this.configInfo.playbackLowWaterFrame&&(this.socketSending||(this._curSpeed?(this.setSpeed(this._curSpeed),this.event.emit("speedNum",this._curSpeed)):(this.setSpeed("1"),this.event.emit("speedNum",1)))),this.isStream&&this.frameBuffer.length>=this.configInfo.streamHighWaterFrame){let e=this.frameBuffer.length-this.configInfo.streamHighWaterFrame;this.frameBuffer.splice(0,e)}}},v.prototype.displayAudioFrame=function(e){if(this.playerState!=E)return!1;if(this.speeding)return!0;if(this.seeking&&(this.restartAudio(),this.loadingState=!1,this.seeking=!1),this.pcmPlayer){(new Date).getTime();this.pcmPlayer.feed(e.d)}return!0},v.prototype.displayVideoFrame=function(e){if(this.playerState!=E)return!1;if(this.seeking&&(this.restartAudio(),this.loadingState=!1,this.seeking=!1),this.drawingState){this.canvas.toBlob((e=>{this._onSnapshot(e)})),this.drawingState=!1;(function(){const e=document.createElement("a");document.body.appendChild(e),e.style.display="none"})()}(new Date).getTime();var t=new Uint8Array(e.d);return this.videoInitStatus?(this.renderVideoFrame(t),!0):this.videoFrameLen>=25?(this.videoInitStatus=!0,this.renderVideoFrame(t),this.startTime=new Date,!0):void 0},v.prototype.renderVideoFrame=function(e){this.webglPlayer.renderFrame(e,this.videoWidth,this.videoHeight,this.yLength,this.uvLength)},v.prototype.onFileData=function(e){var t;t={t:p.a.kFeedDataReq,d:e},this.decodeWorker.postMessage(t,[t.d])},v.prototype.onsocketActiveClose=function(e,t){let i="连接失败";this.serverDataTimeout&&(this.serverDataTimeout=!1),this.decoderErrorFlag?(this.event.emit("CLIENT_LINK_ERROR_ONE"),i=(this.configInfo.deviceName?this.configInfo.deviceName+"：":"")+"数据接收超时！(0x"+this.serverDeviceUnLinkCode.toString(16)+")",this.decoderErrorFlag=!1):this.socketNoActive?(this.event.emit("CLIENT_LINK_ERROR_THREE"),i=(this.configInfo.deviceName?this.configInfo.deviceName+"：":"")+"视频加载失败，请检查设备或网络配置！",this.socketNoActive=!1):1005==e||1e3==e||t?this.decoderErrorFlag?(this.event.emit("CLIENT_LINK_ERROR_ONE"),i=(this.configInfo.deviceName?this.configInfo.deviceName+"：":"")+"链接异常(0x"+this.serverDeviceUnLinkCode.toString(16)+")",this.decoderErrorFlag=!1):this.event.emit("CLIENT_LINK_ERROR_ONE"):this.serverDeviceUnLinkCode?(i=(this.configInfo.deviceName?this.configInfo.deviceName+"：":"")+"链接异常(0x"+this.serverDeviceUnLinkCode.toString(16)+")",this.event.emit("CLIENT_LINK_ERROR_ONE")):(i=(this.configInfo.deviceName?this.configInfo.deviceName+"：":"")+"链接异常("+e+")",this.event.emit("CLIENT_LINK_ERROR_ONE")),this.stop("linkfail",i)},v.prototype.onsocketTalkActiveClose=function(e){1005==e||1e3==e||this.talkErrorDestroy()},v.prototype.onsocketNoActive=function(){this.stop(),this.socketNoActive=!0},v.prototype.onInitDecoder=function(e){if(this.playerState!=R)if(this.logger.logInfo("Init decoder response "+e.e+"."),0==e.e){const e={t:p.a.fetchStream,url:this.configInfo.url,msg:"start"};this.downloadWorker.postMessage(e),this.socketSending=!0,this.showLoading()}else this.reportPlayError(e.e)},v.prototype.onSendDataCallback=function(){const e={t:p.a.kOpenDecoderReq};this.decodeWorker.postMessage(e)},v.prototype.onOpenDecoder=function(e){this.startDecoding()},v.prototype.startDecoding=function(){var e={t:p.a.kStartDecodingReq,i:5};this.decodeWorker.postMessage(e),this.decoding=!0},v.prototype.onGetParam=function(e){if(this.playerState!=R&&this.playerState!=k)if(0==e.e){if(!this.playFirstGetParams&&("video"==e.type&&(this.frameRate!=e.v.d||this.pixFmt!=e.v.p||this.videoWidth!=e.v.w||this.videoHeight!=e.v.h)||"audio"==e.type&&(this.audioChannels!=e.a.c||this.audioSampleRate!=e.a.r||this.sampleFmt!=e.a.f)))return this.resetPlayer(),void setTimeout((()=>{this.reconnection()}),1e3);"audio"==e.type?this.onAudioParam(e.a):this.onVideoParam(e.v),this.decoding=!0,this.buffering=!1,this.loadingState=!1,this.hideAll(),this.event.emit("MEDIA_INFO",e)}else this.reportPlayError(e.e)},v.prototype.onVideoParam=function(e){if(this.playerState==R)return;this.logger.logInfo("Video param duation:"+e.d+" pixFmt:"+e.p+" width:"+e.w+" height:"+e.h+"."),this.frameRate=e.d,this.interval=1e3/this.frameRate,this.pixFmt=e.p,this.canvas.width=e.w,this.canvas.height=e.h;let t=Math.ceil(1e5*parseInt(getComputedStyle(this.el).width)/e.w)/1e5,i=Math.ceil(1e5*parseInt(getComputedStyle(this.el).height)/e.h)/1e5;this.canvas.style.cssText=`transform: scale(${t},${i});transform-origin: 0 0;position:absolute;left: 0;top: 0;`,this.videoWidth=e.w,this.videoHeight=e.h,this.yLength=this.videoWidth*this.videoHeight,this.uvLength=this.videoWidth/2*(this.videoHeight/2)},v.prototype.onAudioParam=function(e){if(this.playerState!=R&&(this.logger.logInfo("Audio param sampleFmt:"+e.f+" channels:"+e.c+" sampleRate:"+e.r+"."),0!=e.r&&0!=e.c)){var t=e.f;this.sampleFmt=e.f;var i=e.c,o=e.r,r="16bitInt";switch(t){case 0:r="8bitInt";break;case 1:r="16bitInt";break;case 2:r="32bitInt";break;case 3:r="32bitFloat";break;default:this.logger.logError("Unsupported audio sampleFmt "+t+"!")}this.logger.logInfo("Audio encoding "+r+"."),this.playInitState&&(this.pcmPlayer=new s({encoding:r,channels:i,sampleRate:o,flushingTime:300}),this.audioEncoding=r,this.audioChannels=i,this.audioSampleRate=o,this.playInitState=!1)}},v.prototype.onAudioFrame=function(e){this.audioFrameBuffer.push(e)},v.prototype.onVideoFrame=function(e){this.bufferFrame(e)},v.prototype.bufferFrame=function(e){4==e.t&&this.videoFrameLen++,this.frameBuffer.push(e),this.getBufferTimerLength()>=500&&this.buffering&&(this.buffering=!1,this.loadingState=!1)},v.prototype.onSocketLinkState=function(e){var t;switch(this.logger.logInfo("Open socket response "+e.s+"."),e.s){case 1:t={t:p.a.getHeartBeatRequest},this.decodeWorker.postMessage(t);break;case 2:case 3:this.stop()}},v.prototype.onGetSetPlayBackStartTimeReq=function(e){this.startDecoding();const t={t:p.a.getSetPlayBackStartTimeReq,b:e.b};this.downloadWorker.postMessage(t)},v.prototype.onHeartPingResp=function(){const e={t:p.a.heartPingResp};this.downloadWorker.postMessage(e)},v.prototype.onWasmLoaded=function(){this.event.emit("WASMLOADED")},v.prototype.onDecoderError=function(e){let t="连接失败(服务)";this.serverDeviceUnLinkCode=e.s,g[e.s]&&g[e.s].eventStr&&(this.event.emit(g[e.s].eventStr,g[e.s]),t=(this.configInfo.deviceName?this.configInfo.deviceName+"：":"")+g[e.s].msg+"(0x"+this.serverDeviceUnLinkCode.toString(16)+")",this.stop("linkfail",t)),this.event.emit("decoderError",e),this.decoderErrorFlag=!0},v.prototype.onGetHeartBeatRequest=function(e){const t={t:p.a.DownloaderHeartBeat,b:e.b,l:e.l};this.downloadWorker.postMessage(t),this.talkWorker.postMessage(t)},v.prototype.onGetHandshakeReq=function(e){const t={t:p.a.DownloaderHandshakeReq,b:e.b,l:e.l},i={t:p.a.TalkHandshakeReq,b:e.b,l:e.l};this.downloadWorker.postMessage(t),this.talkWorker.postMessage(i),this.setSpeed("1")},v.prototype.onGetSetPlayBackSpeedReq=function(e){const t={t:p.a.getSetPlayBackSpeedReq,b:e.b};this.downloadWorker.postMessage(t)},v.prototype.onGetSetPlayBackStartReq=function(e){const t={t:p.a.getSetPlayBackStartReq,b:e.b};this.downloadWorker.postMessage(t)},v.prototype.onDeviceReady=function(){const e={t:p.a.getSetPlayBackStartReq};this.decodeWorker.postMessage(e)},v.prototype.onResponseCurDateTime=function(e){String(e.d).replace("n","");this.currentTimestamp=e.d;const t=new Date(this.endtime).getTime();parseInt(e.d)>=t&&this.event.emit("MEDIA_PROGRESS_INFO_STOP",parseInt(e.d)),this.event.emit("MEDIA_PROGRESS_INFO",parseInt(e.d))},v.prototype.onEventTypeFifoFull=function(e){this.playerState==E&&(this.setSpeed("0"),this.event.emit("speedNum",0))},v.prototype.onEventTypeFifoEnough=function(e){this.playerState==E&&(this._curSpeed?(this.setSpeed(this._curSpeed),this.event.emit("speedNum",this._curSpeed)):(this.setSpeed("1"),this.event.emit("speedNum",1)))},v.prototype.onPlaybakcRecordList=function(e){let t=JSON.parse(e.d);t.rec_file_infos?this.isStream||this.event.emit("DEVICE_RECORD_LIST",t):this.showMsg("linkfail",(this.configInfo.deviceName?this.configInfo.deviceName+"：":"")+"数据列表为空！")},v.prototype.onServerDataTimeout=function(e){this.serverDataTimeout=!0,this.stop()},v.prototype.onGetHandsharkRes=function(e){const t=window.btoa(String.fromCharCode(...e.b)),i={t:p.a.fetchStream,url:this.configInfo.url+"&public_key="+t,msg:"start"};this.downloadWorker.postMessage(i),this.socketSending=!0,this.showLoading()},v.prototype.onCloseDecoderRsp=function(){this.event.emit("MEDIA_STOP"),this.decodeWorker.terminate(),this.downloadWorker.terminate(),this.talkWorker.terminate()},v.prototype.speed=function(e){if(!e)return;this.socketSending="0"!=e;const t={t:p.a.getSetPlayBackSpeedReq,l:e};this.decodeWorker.postMessage(t)},v.prototype.restartAudio=function(){this.pcmPlayer&&(this.pcmPlayer.destroy(),this.pcmPlayer=null),0!=this.audioSampleRate&&0!=this.audioChannels&&(this.pcmPlayer=new s({encoding:this.audioEncoding,channels:this.audioChannels,sampleRate:this.audioSampleRate,flushingTime:1e3}),this.volume(this.currentVolume))},v.prototype.onDecodeFinished=function(e){this.pauseDecoding()},v.prototype.getBufferTimerLength=function(){if(!this.frameBuffer||0==this.frameBuffer.length)return 0;let e=this.frameBuffer[0],t=this.frameBuffer[this.frameBuffer.length-1];return Math.abs(t.s-e.s)},v.prototype.closeWebsocket=function(){const e={t:p.a.closeWebsocket};this.downloadWorker.postMessage(e)},v.prototype.pauseDecoding=function(){var e={t:p.a.kPauseDecodingReq};this.decodeWorker.postMessage(e),this.decoding=!1},v.prototype.formatTime=function(e){return(Math.floor(e/3600)<10?"0"+Math.floor(e/3600):Math.floor(e/3600))+":"+(Math.floor(e/60%60)<10?"0"+Math.floor(e/60%60):Math.floor(e/60%60))+":"+(e=Math.floor(e%60)<10?"0"+Math.floor(e%60):Math.floor(e%60))},v.prototype.reportPlayError=function(e,t,i){},v.prototype.registerVisibilityEvent=function(e){var t="hidden";function i(i){var o=!0,s=!1,r={focus:o,focusin:o,pageshow:o,blur:s,focusout:s,pagehide:s},a=o;a=(i=i||window.event).type in r?r[i.type]:document[t]?s:o,e(a)}t in document?document.addEventListener("visibilitychange",i):(t="mozHidden")in document?document.addEventListener("mozvisibilitychange",i):(t="webkitHidden")in document?document.addEventListener("webkitvisibilitychange",i):(t="msHidden")in document?document.addEventListener("msvisibilitychange",i):"onfocusin"in document?document.onfocusin=document.onfocusout=i:window.onpageshow=window.onpagehide=window.onfocus=window.onblur=i,void 0!==document[t]&&i({type:document[t]?"blur":"focus"})},v.prototype.snapshot=function(){this.drawingState=!0},v.prototype.onVideoDownRep=function(e){let t=e.d.map((e=>e.buffer));const i=document.createElement("a");i.style.display="none";const o=new Blob(t,{type:"video/mp4"}),s=window.URL.createObjectURL(o);i.href=s,i.download="录像"+(new Date).getTime()+".mp4",document.body.appendChild(i),i.click(),i.remove(),e.d=[]},v.prototype.onVideoDownChumksRep=function(e){e.d.length>=25&&(this.recoderPause(),this.event.emit("VIDEO_MAX_END"))},v.prototype.initTalkWorker=function(e){var t=this;this.talkWorker=new Worker(e+"talk.worker.js"),this.talkWorker.onmessage=function(e){var i=e.data;switch(i.t){case p.a.kGetDeviceInfo:t.decodeWorker.postMessage(i);break;case p.a.socketActiveClose:t.onsocketTalkActiveClose(i.d);break;case p.a.getTalkStartReq:const e={t:p.a.getTalkStartReq,b:"",msg:""};t.decodeWorker.postMessage(e);break;case p.a.socketNoActive:t.onTalkSocketNoActive();break;case p.a.DestroyTalkRes:break;case p.a.initTalkEncode:const o={t:p.a.initTalkEncode,b:"",msg:""};t.decodeWorker.postMessage(o)}}},v.prototype.onTalkStartRep=function(e){const t={t:p.a.talkStartRep,b:e.b,msg:"start"};this.talkWorker.postMessage(t)},v.prototype.onStartTalkEncoder=function(e){const t={t:p.a.kStartTalkEncoderRsp,b:e.b};this.decodeWorker.postMessage(t),this.event.emit("TALK_START")},v.prototype.talk=function(e){const t={t:p.a.fetchStream,url:e};this.talkWorker.postMessage(t)},v.prototype.onGetAudioDataReq=function(){this.getAudioDataStatus=!0,this.startRecord()},v.prototype.onGetAudioDataRep=function(e){this.talkWorker.postMessage(e)},v.prototype.onkTalkEncoderdeviceready=function(){const e={t:p.a._getTalkStartReq,b:"",msg:""};this.decodeWorker.postMessage(e)},v.prototype.onPlaybackOver=function(){this.event.emit("PLAYBACKOVER")},v.prototype.onDecoderTalkError=function(e){g[e.s]&&g[e.s].eventStr&&this.event.emit(g[e.s].eventStr,g[e.s],"talk"),this.event.emit("CLIENT_TALK_ERROR_ONE",e),this.talkErrorDestroy()},v.prototype.startRecord=async function(){if(this.getAudioDating=!0,!this.talkRecord){let e=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:48e3,sampleSize:16,channelCount:1,volume:1,noiseSuppression:!0,echoCancellation:!0,autoGainControl:!0}}).catch((e=>{this.event.emit("getUserMediaError")}));this.talkStream=e,this.talkRecord=new y(this.talkStream),this.talkRecord.start(),this.talkTimer=setInterval((async()=>{if(this.getAudioDating&&this.talkRecord){let t=this.talkRecord.getBlob();this.talkRecord.clear();let i=await(e=t,new Promise(((t,i)=>{let o=new FileReader;o.readAsArrayBuffer(e),o.onload=function(e){o.result.slice(0,24e3),t({d:o.result,t:(new Date).getTime(),h:o.result.byteLength})}})));const o={t:p.a.pcmDataReq,p:i};this.decodeWorker.postMessage(o)}var e}),50)}},v.prototype.talkPause=function(){this.talkRecord&&(clearInterval(this.talkTimer),this.talkRecord.stop(),this.talkRecord.clear(),this.talkRecord=null,this.talkStream.getTracks().forEach((e=>e.stop())),this.getAudioDating=!1)},v.prototype.onCloseTalk=function(e){this.event.emit("CLIENT_TALK_ERROR_ONE",e),this.talkDestroy()},v.prototype.onAutoCloseTalk=function(e){this.event.emit("CLIENT_TALK_END",e),this.talkDestroy()},v.prototype.onTalkSocketNoActive=function(){this.event.emit("CLIENT_TALK_ERROR_THREE"),this.talkErrorDestroy()},v.prototype.onTalkStopResponseToTalkWorker=function(e){const t={t:p.a.talkStopResponse_to_talkWorker,b:e.b};this.talkWorker.postMessage(t)},v.prototype.onTalkStopResponse=function(){const e={t:p.a.talkStopResponse_to_dec},t={t:p.a.DestroyTalkReq};this.talkWorker.postMessage(t),this.decodeWorker.postMessage(e),this.event.emit("TALK_END")},v.prototype.talkErrorDestroy=function(){this.talkRecord&&(clearInterval(this.talkTimer),this.talkRecord.stop(),this.talkRecord.clear(),this.talkRecord=null,this.talkStream.getTracks().forEach((e=>e.stop())),this.getAudioDating=!1);const e={t:p.a.talkStopResponse_to_dec},t={t:p.a.DestroyTalkReq};this.talkWorker.postMessage(t),this.decodeWorker.postMessage(e)},v.prototype.talkDestroy=function(){this.talkRecord&&(clearInterval(this.talkTimer),this.talkRecord.stop(),this.talkRecord.clear(),this.talkRecord=null,this.talkStream.getTracks().forEach((e=>e.stop())),this.getAudioDating=!1);const e={t:p.a.DestroyTalkReq};this.decodeWorker.postMessage(e)},v.prototype.onServerMaxPlayDurationReached=function(){this.event.emit("SERVER_MAX_PLAY_DURATION_REACHED")};t.default=v}])}));